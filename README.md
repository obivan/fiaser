# fiaser

Утилита предназначена для конвертации выгрузок БД ФИАС в формате XML (и в формате ГАР),
представленных на сайте https://fias.nalog.ru/Updates, в файл базы данных SQLite.
Сохраняет содержимое выгрузок в виде набора таблиц, схема которых строится на основе выгрузок xsd-схем.
Такой формат позволяет удобнее работать с сырыми данными ФИАС: доступно создание индексов,
выполнение сложных SQL-запросов, поиска данных и т.д. При работе с xml-файлами, использование этих
возможностей затруднено. Также такой источник данных проще подключить через механизм FDW к PostgreSQL или
использовать как промежуточный слой в конвейере загрузки данных.

## Установка

Скачайте файл fiaser-0.1.0-standalone.jar со страницы релизов или используйте
`lein uberjar` для сборки из исходного кода.

## Использование

Необходимо загрузить полную БД ФИАС в формате XML (или БД ГАР ФИАС) и схемы соответствующего формата:
Схемы выгружаются по ссылкам "XSD схемы выгрузки БД в формате ГАР" или "XSD схемы выгрузки БД ФИАС в формате XML".
Далее распаковать загруженные файлы и указать пути к каталогам с распакованными данными и выходному файлу:

    $ java -jar fiaser-0.1.0-standalone.jar convert --xml-dir <xml-файлы> --xml-schema-dir <схемы> --sqlite-file <выходной-файл>

## Опции

* `-d, --xml-dir DIR`. Определяет расположение каталога с данными ФИАС. По-умолчанию текущий каталог.
* `-s, --xml-schema-dir DIR`. Определяет расположение каталога со схемами ФИАС. По-умолчанию текущий каталог.
* `-o, --sqlite-file FILE`. Определяет имя и местоположение выходного файла SQLite. По-умолчанию `fias.sqlite` в текущем каталоге.
* `-h, --help`. Справка по ключам и использованию утилиты

## Примеры

    $ java -jar fiaser-0.1.0-standalone.jar convert --xml-dir ./fias_data --xml-schema-dir ./fias_schemas --sqlite-file fias.sqlite
    $ java -jar fiaser-0.1.0-standalone.jar convert --xml-dir ./gar_data --xml-schema-dir ./gar_schemas --sqlite-file fias-gar.sqlite

### Ошибки и ограничения

На данный момент поддерживается работа только с полной (не дельта) выгрузкой ФИАС.

При обработке данные проверяются на соответствие модели, описанной в xsd-схеме.
Строго говоря, проверка только одна: на обязательность заполнения. То есть, если в xsd-схеме
аттрибут поля use="required", то ожидается, что поле будет присутствовать во всех строках коллекции.
На данный момент (июль 2020) данные ФИАС полностью проходят валидацию по своей модели и конвертируются в
SQLite без ошибок.
Данные в новом формате ГАР ФИАС имеют ошибки как на уровне схем, так и уровне данных. Ниже приведен список
известных ошибок:
* В файле схемы `AS_PARAM_2_251_02_04_01_01.xsd` отсутствует известный тип поля. При конвертации будет использован тип `text`.
* Файлы схем `AS_CHANGE_HISTORY_251_21_04_01_01.xsd`, `AS_ADM.HIERARCHY_2_251_04_04_01_01.xsd`,
`AS_ADDR.OBJ.DIVISION_2_251_19_04_01_01.xsd` и `AS_MUN.HIERARCHY_2_251_10_04_01_01.xsd` имеют одинаковые имена
коллекций и элементов: ITEMS/ITEM. Это создает коллизию имен коллекций справочника. Утилита конвертации исправляет 
данную ошибку подменой имен коллекций и элементов для определенных файлов схем и соответствующих файлов данных.
* Структура схемы `AS_NORMATIVE.DOCS.KINDS_2_251_09_04_01_01.xsd` отличается от остальных выделением заголовочной
части коллекции.
* Часть данных не проходит валидацию по схеме `AS_PARAM_2_251_02_04_01_01.xsd` по причине отсутствия обязательного
поля `VALUE` (Значение параметра). Такие записи при конвертации пропускаются, их идентификаторы выводятся в `stdout`.

### Длительность конвертации
Данные ФИАС конвертируются приблизительно за 2 - 2.5 часа.
Обработка ГАР ФИАС выполняется примерно 6.5 часов.

## Лицензия

Copyright © 2020 Vadim Komarov

This program and the accompanying materials are made available under the
terms of the Eclipse Public License 2.0 which is available at
http://www.eclipse.org/legal/epl-2.0.

This Source Code may also be made available under the following Secondary
Licenses when the conditions for such availability set forth in the Eclipse
Public License, v. 2.0 are satisfied: GNU General Public License as published by
the Free Software Foundation, either version 2 of the License, or (at your
option) any later version, with the GNU Classpath Exception which is available
at https://www.gnu.org/software/classpath/license.html.
